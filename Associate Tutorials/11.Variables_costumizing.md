# Summary Notes: Terraform Variables — Customizing Configuration

## What input variables are (and aren’t)
- **Input variables** give end‑users a safe interface to customize behavior **before** a run starts.
- They **do not change during** `plan`/`apply`/`destroy` — no runtime mutation.
- Great for reusability (modules), consistency, and avoiding hard‑coded values.

---

## Common variable patterns
### 1) Declare variables (recommended in `variables.tf`)
```hcl
variable "aws_region" {
  description = "AWS region"
  type        = string
  default     = "us-west-2"
}

variable "vpc_cidr_block" {
  description = "CIDR block for VPC"
  type        = string
  default     = "10.0.0.0/16"
}
```
Use in config via `var.<name>`:
```hcl
provider "aws" {
  region = var.aws_region
}

module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "5.7.0"
  cidr    = var.vpc_cidr_block
}
```

### 2) Numbers & booleans
```hcl
variable "instance_count" {
  description = "Number of instances to provision."
  type        = number
  default     = 2
}

variable "enable_vpn_gateway" {
  description = "Enable a VPN gateway in your VPC."
  type        = bool
  default     = false
}

module "ec2_instances" {
  source         = "./modules/aws-instance"
  instance_count = var.instance_count
  # enable_vpn_gateway is consumed by the VPC module:
  # enable_vpn_gateway = var.enable_vpn_gateway
}
```

### 3) Collections: lists & maps
```hcl
variable "public_subnet_cidr_blocks" {
  type    = list(string)
  default = ["10.0.1.0/24","10.0.2.0/24","10.0.3.0/24","10.0.4.0/24"]
}

variable "private_subnet_cidr_blocks" {
  type    = list(string)
  default = ["10.0.101.0/24","10.0.102.0/24","10.0.103.0/24","10.0.104.0/24"]
}

variable "public_subnet_count"  { type = number, default = 2 }
variable "private_subnet_count" { type = number, default = 2 }

module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "5.7.0"
  private_subnets = slice(var.private_subnet_cidr_blocks, 0, var.private_subnet_count)
  public_subnets  = slice(var.public_subnet_cidr_blocks,  0, var.public_subnet_count)
}
```

### 4) Tags via map
```hcl
variable "resource_tags" {
  description = "Tags to set for all resources"
  type        = map(string)
  default = {
    project     = "project-alpha"
    environment = "dev"
  }
}

# Usage
tags = var.resource_tags
```

---

## Assigning values (precedence, lowest → highest)
1. **Defaults** in `variable` blocks  
2. Files named **`terraform.tfvars`** or `*.auto.tfvars` (auto-loaded)  
3. Explicit **`-var-file=...`**  
4. **Environment variables** `TF_VAR_<name>`  
5. **CLI flags** `-var 'name=value'`

Examples:
```bash
terraform apply -var ec2_instance_type=t2.micro
# or terraform.tfvars
ec2_instance_type = "t3.micro"
resource_tags = { project = "project-alpha", environment = "dev", owner = "me@example.com" }
instance_count = 3
```

> Variables **must have a value** (default or provided). Values must be **literals** (not expressions or other variables).

---

## String interpolation & functions
- Interpolate with `"${ ... }"` inside strings.
```hcl
name = "lb-${random_string.lb_id.result}-${var.resource_tags["project"]}-${var.resource_tags["environment"]}"
```
- Work with collections via functions (e.g., `slice`, `regexall`) and test in `terraform console`:
```bash
terraform console
> slice(var.private_subnet_cidr_blocks, 0, 3)
```

---

## Variable validation (catch errors early)
```hcl
variable "resource_tags" {
  type = map(string)
  default = { project = "my-project", environment = "dev" }

  validation {
    condition     = length(var.resource_tags["project"]) <= 16 &&
                    length(regexall("[^a-zA-Z0-9-]", var.resource_tags["project"])) == 0
    error_message = "Project <= 16 chars; letters/numbers/hyphens only."
  }

  validation {
    condition     = length(var.resource_tags["environment"]) <= 8 &&
                    length(regexall("[^a-zA-Z0-9-]", var.resource_tags["environment"])) == 0
    error_message = "Environment <= 8 chars; letters/numbers/hyphens only."
  }
}
# Fails example:
# terraform apply -var='resource_tags={project="my-project",environment="development"}'
```

---

## Structural types (FYI)
- **tuple([types...])** – fixed-length sequence with specified types.  
- **object({ key = type, ... })** – fixed keys with specified value types.

---

## Workflow recap for the tutorial
```bash
git clone https://github.com/hashicorp-education/learn-terraform-variables
cd learn-terraform-variables

terraform init
terraform apply                      # creates infra (VPC, ALB, EC2, etc.)

# Add/modify variables in variables.tf and wire them into main.tf
terraform apply                      # no changes when defaults match

# Provide values via CLI or tfvars
terraform apply -var ec2_instance_type=t2.micro
# or with terraform.tfvars for multiple values

terraform destroy                    # clean up when done
```

---

## Best practices
- Keep all inputs in **`variables.tf`** (with **description** and **type**, defaults when sensible).
- Prefer **explicit types** (`number`, `bool`, `list(string)`, `map(string)`).
- Use **validation** to enforce naming, length, and allowed chars.
- Use **maps/lists** to control tags, counts, and subnet CIDRs.
- Test expressions in **`terraform console`**.
- For reusable modules, document all variables & outputs; keep sensible defaults.

