# Terraform Resource Dependencies ‚Äî Quick Reference

## 1Ô∏è‚É£ Why dependencies matter
Terraform automatically builds a **dependency graph** to determine resource creation and destruction order.  
- **Implicit dependencies:** inferred through references (`aws_instance.example.id`).  
- **Explicit dependencies:** manually specified with `depends_on` when Terraform cannot infer order.  

Terraform creates and destroys resources in **dependency order** ‚Äî even across modules.

---

## 2Ô∏è‚É£ Implicit Dependencies (Automatic)
Terraform infers dependencies based on interpolation and references.

### Example
```hcl
data "aws_ami" "amazon_linux" {
  most_recent = true
  owners      = ["amazon"]
  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*-x86_64-gp2"]
  }
}

resource "aws_instance" "example_a" {
  ami           = data.aws_ami.amazon_linux.id
  instance_type = "t2.micro"
}

resource "aws_instance" "example_b" {
  ami           = data.aws_ami.amazon_linux.id
  instance_type = "t2.micro"
}

resource "aws_eip" "ip" {
  vpc      = true
  instance = aws_instance.example_a.id
}
```
Terraform automatically knows:
- `aws_eip.ip` depends on `aws_instance.example_a`
- `example_a` and `example_b` can be created in parallel

---

## 3Ô∏è‚É£ Explicit Dependencies (`depends_on`)

Use **`depends_on`** when a resource‚Äôs dependency isn‚Äôt visible in HCL (e.g., app configuration, side effects).

### Example
```hcl
resource "aws_s3_bucket" "example" {}

resource "aws_instance" "example_c" {
  ami           = data.aws_ami.amazon_linux.id
  instance_type = "t2.micro"
  depends_on    = [aws_s3_bucket.example]
}

module "example_sqs_queue" {
  source     = "terraform-aws-modules/sqs/aws"
  version    = "3.3.0"
  depends_on = [aws_s3_bucket.example, aws_instance.example_c]
}
```
‚úÖ Terraform will:
- Wait until the **S3 bucket** is created before provisioning the **instance** and **SQS queue**.
- Create resources **sequentially** when explicit dependencies exist.

> ‚ö†Ô∏è **Caution:** Explicit dependencies slow down applies since Terraform must wait for each dependent resource to finish.

---

## 4Ô∏è‚É£ How Terraform determines order

Terraform builds a **graph** internally:  
- **Nodes:** resources, modules, and data sources  
- **Edges:** dependencies inferred from references or `depends_on`  
- **Apply:** creates resources in **topological order**
- **Destroy:** reverses that order

To visualize the graph:
```bash
terraform graph | dot -Tpng > graph.png
```

---

## 5Ô∏è‚É£ Behavior during destroy

Dependencies apply to both **creation** and **destruction**:  
Terraform destroys resources in **reverse dependency order**.

Example:
- Destroys `aws_eip.ip` before `aws_instance.example_a`
- Destroys `example_sqs_queue` before its dependencies (`example_c`, `example` bucket)

---

## 6Ô∏è‚É£ Key Takeaways

‚úÖ **Implicit dependencies** are preferred ‚Äî rely on Terraform‚Äôs graph.  
‚öôÔ∏è **Explicit dependencies** (`depends_on`) only when Terraform cannot infer them.  
üß© **Modules can depend too:** `depends_on` works for both resources and modules.  
üö´ **File order doesn‚Äôt matter:** Terraform‚Äôs graph, not file position, defines order.  
üß≠ **Destroy order = reverse apply order.**  

---

## 7Ô∏è‚É£ Troubleshooting Tips

- Use `terraform plan` to see dependency order in action.
- For deep debugging:
  ```bash
  terraform graph -type=plan | dot -Tsvg > plan.svg
  ```
- Use `depends_on` when:
  - A resource triggers configuration outside Terraform.
  - Terraform lacks visible links between dependent resources.
- Don‚Äôt overuse `depends_on` ‚Äî it increases total apply time.

---

## 8Ô∏è‚É£ Example cleanup
```bash
terraform destroy
```
Terraform will safely destroy resources in dependency order (reverse of creation).

---

## üîç Summary Table

| Type              | Declared via      | Best for                                  | Example Use Case |
|-------------------|------------------|--------------------------------------------|------------------|
| Implicit          | References        | Normal dependencies                        | EIP ‚Üí Instance   |
| Explicit           | `depends_on`     | Hidden or external dependencies            | EC2 ‚Üí S3 Bucket  |
| Module dependency | `depends_on` on module block | Inter-module ordering                    | app depends on network module |

---

### ‚úÖ Best Practices Recap
- Reference IDs instead of forcing order with `depends_on`.
- Use modules to group logical dependencies.
- Reserve `depends_on` for hidden/out-of-band relationships.
- Combine with `lifecycle` blocks (`create_before_destroy`, `ignore_changes`) when appropriate.

---

**Docs:**  
- [Terraform `depends_on` Meta-Argument](https://developer.hashicorp.com/terraform/language/meta-arguments/depends_on)  
- [Understanding the Terraform Dependency Graph](https://developer.hashicorp.com/terraform/internals/graph)
