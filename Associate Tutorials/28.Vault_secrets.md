# Inject Secrets into Terraform using the Vault Provider ‚Äî Summary Notes

## Overview
Instead of using long-lived AWS credentials, you can use **Vault‚Äôs AWS Secrets Engine** to dynamically issue short-lived credentials and inject them into Terraform.  
This improves security and simplifies credential management.

---

## 1Ô∏è‚É£ Workflow Overview
| Role | Responsibility |
|------|----------------|
| **Vault Admin** | Configure Vault AWS Secrets Engine and role with IAM permissions |
| **Terraform Operator** | Use Vault provider to fetch dynamic creds and provision AWS resources |

---

## 2Ô∏è‚É£ Setup Requirements
- Terraform & Vault installed locally  
- AWS account + credentials (for initial Vault configuration)  
- Vault development server (for demo)  

### Start Vault
```bash
vault server -dev -dev-root-token-id="education"
```
Open [http://127.0.0.1:8200](http://127.0.0.1:8200) ‚Üí Login with token **education**.

Clone repository:
```bash
git clone https://github.com/hashicorp-education/learn-terraform-inject-secrets-aws-vault
cd learn-terraform-inject-secrets-aws-vault
```

---

## 3Ô∏è‚É£ Vault Admin Workspace ‚Äî Configure AWS Secrets Engine
`vault-admin-workspace/main.tf`
```hcl
resource "vault_aws_secret_backend" "aws" {
  path                      = "dynamic-aws-creds-vault-admin-path"
  access_key                = var.aws_access_key
  secret_key                = var.aws_secret_key
  default_lease_ttl_seconds = 120
  max_lease_ttl_seconds     = 600
}

resource "vault_aws_secret_backend_role" "admin" {
  backend         = vault_aws_secret_backend.aws.path
  name            = "dynamic-aws-creds-vault-admin-role"
  credential_type = "iam_user"

  policy_document = <<POLICY
{
  "Version": "2012-10-17",
  "Statement": [{
    "Effect": "Allow",
    "Action": ["iam:*", "ec2:*"],
    "Resource": "*"
  }]
}
POLICY
}

output "backend" { value = vault_aws_secret_backend.aws.path }
output "role"    { value = vault_aws_secret_backend_role.admin.name }
```

### Commands
```bash
export TF_VAR_aws_access_key=<AWS_ACCESS_KEY_ID>
export TF_VAR_aws_secret_key=<AWS_SECRET_ACCESS_KEY>
export VAULT_ADDR=http://127.0.0.1:8200
export VAULT_TOKEN=education

terraform -chdir=vault-admin-workspace init
terraform -chdir=vault-admin-workspace apply
```

Vault now issues temporary IAM users via this role.

---

## 4Ô∏è‚É£ Operator Workspace ‚Äî Provision with Dynamic Credentials
`operator-workspace/main.tf`
```hcl
data "terraform_remote_state" "admin" {
  backend = "local"
  config  = { path = "../vault-admin-workspace/terraform.tfstate" }
}

data "vault_aws_access_credentials" "creds" {
  backend = data.terraform_remote_state.admin.outputs.backend
  role    = data.terraform_remote_state.admin.outputs.role
}

provider "aws" {
  region     = "us-east-1"
  access_key = data.vault_aws_access_credentials.creds.access_key
  secret_key = data.vault_aws_access_credentials.creds.secret_key
  token      = data.vault_aws_access_credentials.creds.security_token
}

data "aws_ami" "ubuntu" {
  most_recent = true
  owners      = ["099720109477"]
  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*"]
  }
}

resource "aws_instance" "main" {
  ami           = data.aws_ami.ubuntu.id
  instance_type = "t2.micro"
  tags          = { Name = "dynamic-aws-creds-operator" }
}
```

### Commands
```bash
export VAULT_ADDR=http://127.0.0.1:8200
export VAULT_TOKEN=education

terraform -chdir=operator-workspace init
terraform -chdir=operator-workspace apply
```

‚úÖ You‚Äôll see a **temporary IAM user** in AWS IAM (auto-deleted after TTL).  
‚úÖ An EC2 instance is provisioned using the short-lived credentials.

---

## 5Ô∏è‚É£ Restrict Access ‚Äî Update Vault Role Policy
To revoke EC2 permissions:

Edit in `vault-admin-workspace/main.tf`:
```hcl
"Action": ["iam:*"]
```
Then re-apply:
```bash
terraform -chdir=vault-admin-workspace apply
```

Now, re-running the operator plan will fail:
```
Error: UnauthorizedOperation: You are not authorized to perform this operation.
```

---

## 6Ô∏è‚É£ Key Security & Operational Benefits
‚úÖ Eliminates need for local, static AWS creds  
‚úÖ Centralizes IAM permission control in Vault  
‚úÖ Short-lived credentials reduce risk window  
‚úÖ Revocation is automatic (via Vault lease expiration)  
‚úÖ Operators never see or manage real credentials  

‚ö†Ô∏è **TTL consideration**: If Terraform apply takes longer than the token TTL, the run will fail. Adjust `default_lease_ttl_seconds` accordingly.

---

## 7Ô∏è‚É£ Cleanup
```bash
terraform -chdir=operator-workspace destroy --auto-approve
terraform -chdir=vault-admin-workspace destroy --auto-approve
# Stop Vault
Ctrl + C
```

---

## 8Ô∏è‚É£ Best Practices
- Use **AppRole / OIDC / AWS Auth** for Vault Operator login (not root token).  
- Use **Vault namespaces** for team isolation.  
- Enable **audit logs** in Vault for traceability.  
- Store Vault tokens securely (e.g., Terraform Cloud variable storage).  
- Follow **least-privilege IAM** when designing Vault role policies.

---

## 9Ô∏è‚É£ Troubleshooting
| Issue | Cause | Fix |
|-------|--------|-----|
| `UnauthorizedOperation` | Role lacks permissions | Update Vault role policy |
| `ExpiredToken` | TTL too short | Increase `default_lease_ttl_seconds` |
| `Missing AWS creds` | Vault not reachable | Verify `VAULT_ADDR` & `VAULT_TOKEN` |
| EC2 not created | IAM policy missing `ec2:*` | Re-add EC2 actions |

---

## Summary
‚úÖ Configured Vault AWS Secrets Engine via Terraform  
‚úÖ Generated dynamic short-lived AWS creds  
‚úÖ Used those creds to deploy EC2 via Terraform  
‚úÖ Revoked access by modifying Vault role  
‚úÖ Avoided long-lived credentials entirely üéâ

---

### References
- [Terraform Vault Provider Docs](https://registry.terraform.io/providers/hashicorp/vault/latest/docs)
- [Vault AWS Secrets Engine](https://developer.hashicorp.com/vault/docs/secrets/aws)
- [Terraform + Vault Best Practices](https://developer.hashicorp.com/terraform/tutorials/secrets/vault)
