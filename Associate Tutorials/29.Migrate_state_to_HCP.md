# Migrate State to HCP Terraform ‚Äî Summary Notes

## Overview
Migrate your **local Terraform state file** to **HCP Terraform (Terraform Cloud)** to securely store and manage state remotely.  
This enables **collaboration**, **state versioning**, and **team access control** ‚Äî all without recreating infrastructure.

---

## 1Ô∏è‚É£ Why Migrate?
| Local State (Community Edition) | HCP Terraform State |
|----------------------------------|----------------------|
| Stored on local disk             | Secure, remote storage |
| Manual backups required          | Automatic versioning |
| Hard to share or lock state      | Built-in locking + collaboration |
| CLI-only access                  | Web UI + API integration |

---

## 2Ô∏è‚É£ Prerequisites
- Terraform CLI v1.1+  
- HCP Terraform account and organization  
- Existing local state (from previous `terraform apply`)  

‚ö†Ô∏è **Warning:** Always migrate using the same Terraform version that created the state.  
Newer versions may update the state schema and cause corruption.

---

## 3Ô∏è‚É£ Step 1: Prepare Example Configuration
Clone tutorial repo:
```bash
git clone https://github.com/hashicorp-education/learn-state-migration
cd learn-state-migration
```

Inspect `main.tf`:
```hcl
terraform {
  required_providers {
    random = {
      source  = "hashicorp/random"
      version = "3.3.2"
    }
  }
  required_version = ">= 1.1.0"
}

variable "name_length" {
  description = "Number of words in the pet name"
  default     = 3
}

resource "random_pet" "pet_name" {
  length    = var.name_length
  separator = "-"
}

output "pet_name" {
  value = random_pet.pet_name.id
}
```

Initialize & apply locally:
```bash
terraform init
terraform apply -auto-approve
```

‚úÖ Outputs:
```
pet_name = "mostly-joint-lacewing"
```

You now have a local `terraform.tfstate` file.

---

## 4Ô∏è‚É£ Step 2: Configure Cloud Backend
Update `main.tf` to use HCP Terraform:

```hcl
terraform {
  cloud {
    organization = "YOUR-ORG-NAME"

    workspaces {
      name = "learn-terraform-migrate"
    }
  }

  required_providers {
    random = {
      source  = "hashicorp/random"
      version = "3.3.2"
    }
  }
  required_version = ">= 1.1.0"
}
```

üí° HCP Terraform will automatically **create** the workspace if it doesn‚Äôt exist.  
If it exists, ensure it has **no previous state**.

---

## 5Ô∏è‚É£ Step 3: Authenticate to HCP Terraform
Login via CLI:
```bash
terraform login
```
Follow the browser flow to authorize your token.  
Terraform saves it in:
```
~/.terraform.d/credentials.tfrc.json
```

---

## 6Ô∏è‚É£ Step 4: Reinitialize & Migrate
Reinitialize your config:
```bash
terraform init
```
You‚Äôll be prompted:
```
Should Terraform migrate your existing state?
Enter a value: yes
```
Terraform uploads your local state to the specified **HCP Terraform workspace**.

‚úÖ Output:
```
HCP Terraform has been successfully initialized!
```

---

## 7Ô∏è‚É£ Step 5: Configure Variables in HCP Terraform
1. Log in to [app.terraform.io](https://app.terraform.io)
2. Navigate to **Workspaces ‚Üí learn-terraform-migrate ‚Üí Variables**
3. Add a new **Terraform variable**:
   - **Key:** `name_length`
   - **Value:** `5`
4. (If needed) add cloud provider credentials under **Environment Variables**.

---

## 8Ô∏è‚É£ Step 6: Trigger a Remote Run
Remove your local state (optional but recommended):
```bash
rm terraform.tfstate
```

Trigger a remote apply:
```bash
terraform apply
```
Terraform runs remotely and streams logs to your terminal.  
Example plan:
```
-/+ destroy and then create replacement
Plan: 1 to add, 0 to change, 1 to destroy.
```

‚úÖ Output after apply:
```
pet_name = "possibly-eminently-sadly-inspired-mongoose"
```

You can view the full run in the workspace UI.

---

## 9Ô∏è‚É£ Step 7: Destroy Resources
To clean up remotely:
```bash
terraform destroy
```
Terraform performs a remote destroy operation via HCP Terraform.

---

## üîü Key Differences Between CLI and HCP Workspaces

| Terraform CLI Workspaces | HCP Terraform Workspaces |
|---------------------------|---------------------------|
| Multiple states per directory | One state per workspace |
| Local file isolation | Full backend isolation |
| Local execution | Remote execution in HCP Terraform |
| Manual state sharing | Secure, managed state access |

---

## ‚úÖ Benefits of Migrating to HCP Terraform
- **Secure remote state** (no local files)
- **Automatic state versioning & locking**
- **Collaboration-friendly** (team runs, VCS integration)
- **Policy enforcement** via Sentinel
- **Integrated logs & run history**

---

## ‚ö†Ô∏è Troubleshooting
| Issue | Cause | Fix |
|--------|-------|-----|
| Workspace already has state | Trying to overwrite existing workspace | Use a new workspace or delete the existing state |
| Login error | Invalid or expired credentials | Re-run `terraform login` |
| Plan fails after migration | Terraform version mismatch | Use same CLI version as original apply |

---

## üßπ Cleanup & Optional Workspace Removal
Delete remote infra:
```bash
terraform destroy
```
Optionally, delete the workspace in HCP Terraform UI under **Settings ‚Üí Destruction & Deletion**.

---

## Summary
‚úÖ Migrated local state ‚Üí HCP Terraform workspace  
‚úÖ Configured authentication and remote backend  
‚úÖ Verified migration & remote execution  
‚úÖ Cleaned up infrastructure safely  

---

### References
- [HCP Terraform Documentation](https://developer.hashicorp.com/terraform/cloud-docs)
- [Migrating Local State](https://developer.hashicorp.com/terraform/cloud-docs/migrate/state)
- [Terraform Login Guide](https://developer.hashicorp.com/terraform/cli/commands/login)
