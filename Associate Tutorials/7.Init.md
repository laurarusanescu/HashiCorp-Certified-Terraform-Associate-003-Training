# Summary Notes: `terraform init` — Providers, Modules, Lock Files

## Core Terraform Workflow (after writing config)
1) **init** – prepares workspace: configures backend, downloads **providers & modules**, creates/updates **lock file**.
2) **plan** – previews changes.
3) **apply** – performs creates/updates/destroys from the plan.

---

## Tutorial Goal
Initialize a Terraform workspace that uses **local & remote modules**, explore the **.terraform** directory and **.terraform.lock.hcl**, and **update provider/module versions** to understand `terraform init`’s role.

---

## Prerequisites
- Terraform **v1.6+** (or HCP Terraform variant)
- Example repo:
  ```bash
  git clone https://github.com/hashicorp-education/learn-terraform-init
  cd learn-terraform-init
  ```

### Repo Layout (abridged)
```
.
├─ main.tf                      # resources, data sources, modules
├─ terraform.tf                 # terraform block: providers, (remote) backend, TF version
├─ variables.tf                 # input variables
└─ modules/aws-ec2-instance     # local module
```

---

## Initialize the Workspace
```bash
terraform init
```
What happens:
- **Backend** is initialized (defaults to **local** if no `cloud`/`backend` block).
- **Modules**:
  - Local module (`modules/aws-ec2-instance`) is referenced directly.
  - Remote module (`joatmon08/hello/random`) is **downloaded** to `.terraform/modules/...`.
- **Providers**:
  - If **lock file exists**, install **locked** versions.
  - Else, use `required_providers` to resolve versions and **create** the lock file.
- **Lock file** (`.terraform.lock.hcl`): records provider **versions & hashes** for reproducible runs.
- Finishes with success message + reminder to re-run `init` after backend/module changes.

Validate after init:
```bash
terraform validate
# Success! The configuration is valid.
```

---

## Initialization Artifacts
- **`.terraform.lock.hcl`** – provider pinning:
  - If versions conflict with `required_providers`, Terraform prompts to re-init (often with `-upgrade`).
- **`.terraform/`** – internal cache (do **not** commit or modify):
  - `modules/` – local copy of remote modules + `modules.json` summary (root, local, remote).
  - `providers/` – provider binaries cached as `[hostname]/[namespace]/[name]/[version]/[os_arch]`.

Example:
```
.terraform
├─ modules/
│  ├─ hello/                 # downloaded remote module
│  └─ modules.json
└─ providers/
   └─ registry.terraform.io/hashicorp/{aws,random}/<version>/<os_arch>/...
```

---

## Update Provider & Module Versions
1) **Change versions** in `terraform.tf` and `main.tf`:
   - `random` provider → `3.6.1`
   - `hello` module → `6.0.0`
2) Re-init:
```bash
terraform init
# May fail due to lock mismatch -> use:
terraform init -upgrade
```
- `-upgrade` updates providers **within constraints** and refreshes the **lock file**.
- Providers directory may show multiple versions, but Terraform uses the **version in the lock file**.

### After Upgrades: Validate & Fix Arguments
- New module versions can change **required/allowed inputs**.
- Update module block to match new schema (e.g., replace `hello`/`second_hello` with `hellos` map, add `some_key`).
```bash
terraform validate
# Success! The configuration is valid.
```

---

## When to Run `terraform init`
- New configuration or cloned repo (first run).
- You **add/remove/change** a **module** or **provider** (or their **versions**).
- You **add/remove/change** the **backend** or **cloud** blocks.
- After switching workspaces or changing dependency constraints.

---

## Handy Commands
```bash
terraform init            # initialize / install providers & modules
terraform init -upgrade   # upgrade providers/modules within constraints; update lock file
terraform get             # (legacy) download modules after source/version changes
terraform validate        # checks syntax & internal consistency
terraform providers       # see provider requirements & sources
```

---

## Key Takeaways
- `init` underpins reproducibility: **backend**, **providers & modules**, **lock file**.
- **Lock file** belongs in version control; `.terraform/` does not.
- Use `-upgrade` to resolve lock/version drifts; then **validate** and fix any breaking changes.
