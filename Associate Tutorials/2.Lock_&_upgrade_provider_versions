# Summary Notes: Lock and Upgrade Provider Versions in Terraform

## Overview

Terraform **providers** enable Terraform to interact with APIs of
external platforms and services. As these APIs evolve, provider
maintainers update and version providers. To ensure consistency across
users and automation, it's critical to lock and manage provider
versions.

Terraform offers two key mechanisms to manage provider versions: 1.
**Provider version constraints** --- defined in the `terraform` block.
2. **Dependency lock file (`.terraform.lock.hcl`)** --- automatically
created and updated by Terraform.

Proper version management prevents inconsistent infrastructure behavior
across different environments.

------------------------------------------------------------------------

## Managing Provider Versions

### 1. Specify Version Constraints

-   Defined in the **`required_providers`** block inside the `terraform`
    block.
-   Includes:
    -   **Source:** where to fetch the provider (e.g., `hashicorp/aws`).
    -   **Version:** using operators like:
        -   `=` for an exact version
        -   `>=` for minimum version
        -   `~>` for compatible upgrades within a major/minor version

Example:

``` hcl
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = ">= 4.5.0"
    }
  }
  required_version = "~> 1.2"
}
```

### 2. Use the Dependency Lock File

-   Terraform automatically generates `.terraform.lock.hcl` during
    initialization (`terraform init`).
-   Records the **exact provider versions** and their cryptographic
    hashes.
-   Ensures all users and automation pipelines use identical provider
    versions.
-   Should be **checked into version control**.

Example:

``` hcl
provider "registry.terraform.io/hashicorp/aws" {
  version     = "4.5.0"
  constraints = ">= 4.5.0"
  hashes = [ "h1:PR5m6lcJZzSIYqfhnMd0YWTN+On2XGgfYV5AKIvOvBo=", ... ]
}
```

If the lock file doesn't exist, Terraform downloads the **latest
version** that matches version constraints.\
If it does exist, Terraform installs the **exact versions** listed in
the lock file.

------------------------------------------------------------------------

## Practical Example: AWS and Random Providers

### Project Structure

-   `main.tf`: defines AWS and random providers with resources.
-   `terraform.tf`: specifies required provider versions and Terraform
    version.
-   `.terraform.lock.hcl`: maintains locked provider versions.

### Initialization

``` bash
$ terraform init
```

-   Reuses provider versions from the lock file.
-   Installs providers (`aws v4.5.0`, `random v3.1.0`) based on
    constraints.

### Apply Configuration

``` bash
$ terraform apply
```

-   Creates the defined resources (e.g., S3 bucket, random pet name).
-   Uses versions from the lock file for consistency.

  Provider   Version Constraint   No Lock File            With Lock File
  ---------- -------------------- ----------------------- ----------------
  AWS        \>= 4.5.0            Latest (e.g., 5.55.0)   Locked (4.5.0)
  Random     3.1.0                3.1.0                   Locked (3.1.0)

------------------------------------------------------------------------

## Upgrading Provider Versions

### Step 1: Upgrade Providers

Use the `-upgrade` flag to refresh providers within the version
constraints.

``` bash
$ terraform init -upgrade
```

-   Updates `.terraform.lock.hcl` with the latest compatible provider
    versions.

-   Example update:

    ``` hcl
    version     = "5.56.1"
    constraints = ">= 4.5.0"
    ```

### Step 2: Plan and Validate

``` bash
$ terraform plan
```

-   Ensures compatibility with upgraded providers.
-   If successful, commit the updated lock file to version control.

### Tip

-   Never manually edit `.terraform.lock.hcl`.
-   Run `terraform plan` after upgrading providers to confirm no
    breaking changes.

------------------------------------------------------------------------

## Cleaning Up

Destroy the created resources:

``` bash
$ terraform destroy
```

Confirms deletion and removes infrastructure managed by the
configuration.

If using **HCP Terraform**, delete the workspace afterward to fully
clean up.

------------------------------------------------------------------------

## Key Takeaways

-   Always use **version constraints** and a **lock file** to ensure
    consistent provider versions.
-   The **lock file** guarantees reproducible builds across
    environments.
-   Use `terraform init -upgrade` to safely upgrade provider versions.
-   Validate changes with `terraform plan` before committing.

------------------------------------------------------------------------

## Additional Resources

-   [Terraform Dependency Lock File
    Documentation](https://developer.hashicorp.com/terraform/language/files/dependency-lock)
-   [Provider Version Constraint
    Documentation](https://developer.hashicorp.com/terraform/language/expressions/version-constraints)
-   [Call APIs with Terraform
    Providers](https://developer.hashicorp.com/terraform/tutorials/providers/provider-use)
