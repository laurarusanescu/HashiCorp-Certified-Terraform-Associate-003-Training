# Terraform: Target Resources with `-target` — Summary Notes

## Overview
Terraform normally plans/applies **all** changes in your working directory to keep state and real infra consistent. In exceptional cases (e.g., partial failures, provider bugs, or drift recovery), you can target **specific resources/modules** with `-target` during `plan`, `apply`, or `destroy`. Use it **sparingly**—targeting can leave your stack **inconsistent** until you run a full apply.

---

## Prerequisites
- Terraform v1.2+
- AWS account + credentials
- Familiar with standard workflow: `init → plan → apply → destroy`

Clone example:
```bash
git clone https://github.com/hashicorp-education/learn-terraform-resource-targeting
cd learn-terraform-resource-targeting
terraform init
terraform apply
```

---

## What `-target` does (and doesn’t)
- **Does**: Constrains planning to a resource address (or module) and **its upstream dependencies**.
- **Doesn’t**: Update **downstream dependents** of the target; outputs/other resources may stay stale.
- **Implication**: After targeting, **run a full `terraform apply`** to reconcile remaining changes.

> Targeting is a **troubleshooting tool**, not a standard deployment practice.

---

## Example 1 — Target a single resource
Change bucket name generator:
```hcl
resource "random_pet" "bucket_name" {
  length    = 5  # was 3
  separator = "-"
  prefix    = "learning"
}
```

Plan full:
```
terraform plan       # shows bucket + objects replacement due to name change
```
Plan only the random name:
```
terraform plan -target="random_pet.bucket_name"
```
Apply only that:
```
terraform apply -target="random_pet.bucket_name"
```
**Result**: `random_pet.bucket_name` changes, but the **S3 bucket** and **objects** may not—**inconsistency** appears (e.g., `bucket_name` output no longer matches `bucket_arn`). Fix by running a **full** `terraform apply` afterward.

---

## Example 2 — Target a module
Targeting a module applies to **all resources in that module** (and any **upstream dependencies**). E.g.:
```
terraform plan -target="module.s3_bucket"
```
Terraform will also update the dependent `random_pet.bucket_name` if necessary. **But** it won’t touch resources **outside** that module which depend on it.

---

## Example 3 — Target specific instances in a collection
You can target indexed instances from `count`/`for_each`:
```
terraform apply   -target="aws_s3_object.objects[2]"   -target="aws_s3_object.objects[3]"
```
**Caveat**: Dependency is calculated at the **resource level**. If `aws_s3_object.objects[*]` depends on `random_pet.object_names[*]`, changing the **source** collection may force **all** instances of the dependency to update—even when targeting a single index.

---

## Destroy with targeting
Destroy only a subset:
```
terraform destroy -target="aws_s3_object.objects"
```
Then optionally `terraform destroy` to remove everything else.

---

## After targeting: reconcile the world
Always run a plan, and typically a **full `terraform apply`**, to ensure the stack is **consistent**:
```bash
terraform plan
terraform apply
```

---

## Best Practices & Warnings
- ✅ Use `-target` **only** to recover from errors/partial failures.
- ✅ Expect **incomplete** outputs/changes; read the warnings.
- ✅ After targeting, run a **full apply** to converge everything.
- ❌ Don’t rely on `-target` for routine deployments or rollouts.
- ❌ Don’t assume targeting a single index isolates all dependencies—Terraform may need to update related resources.
- ✅ Prefer **`-replace=<addr>`** when you need to recreate a specific resource **without** constraining planning scope.

---

## Handy Commands
```bash
# Normal flow
terraform init
terraform plan
terraform apply

# Targeting
terraform plan   -target="random_pet.bucket_name"
terraform apply  -target="module.s3_bucket"
terraform apply  -target="aws_s3_object.objects[2]" -target="aws_s3_object.objects[3]"
terraform destroy -target="aws_s3_object.objects"

# Reconcile fully after any targeting
terraform plan
terraform apply
```

---

## Key Takeaways
- `-target` narrows plan/apply to specific addresses **and their upstream deps**.
- It’s a **last-resort** tool; it can **desynchronize** resources and outputs.
- After using `-target`, **always** follow up with a **full apply** to restore consistency.
