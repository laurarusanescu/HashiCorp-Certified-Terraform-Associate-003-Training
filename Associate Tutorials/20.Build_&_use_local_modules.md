# Terraform: Build and Use a Local Module

## Overview
This tutorial walks you through creating a **local Terraform module** to provision an **AWS S3 bucket for static website hosting**, wiring it into a root configuration, and managing inputs/outputs. You’ll also learn what to include (and exclude) in a shareable module and how local modules are installed and used.

---

## 1) Why create a local module?
- **Organize & encapsulate** related resources (cleaner root configs, fewer side‑effects).
- **Reusability** across projects/environments.
- **Consistency** and easier updates (change once, reuse everywhere).

---

## 2) Typical module layout
```
modules/
└── aws-s3-static-website-bucket/
    ├── LICENSE
    ├── README.md
    ├── main.tf
    ├── variables.tf
    └── outputs.tf
```
> Terraform treats any directory referenced by a `module` block’s `source` as a module. The files above are conventional but not mandatory.

### What **not** to commit/share
- `terraform.tfstate`, `terraform.tfstate.backup`
- `.terraform/` directory
- `*.tfvars` (unless the repo is also a runnable root config)
> These often contain credentials/state and should be ignored (e.g., via `.gitignore`).

---

## 3) Implement the S3 website module

### **`main.tf`**
```hcl
resource "aws_s3_bucket" "s3_bucket" {
  bucket = var.bucket_name
  tags   = var.tags
}

resource "aws_s3_bucket_website_configuration" "s3_bucket" {
  bucket = aws_s3_bucket.s3_bucket.id

  index_document { suffix = "index.html" }
  error_document { key    = "error.html" }
}

resource "aws_s3_bucket_acl" "s3_bucket" {
  bucket = aws_s3_bucket.s3_bucket.id
  acl    = "public-read"
}

resource "aws_s3_bucket_policy" "s3_bucket" {
  bucket = aws_s3_bucket.s3_bucket.id
  policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Sid       = "PublicReadGetObject"
      Effect    = "Allow"
      Principal = "*"
      Action    = "s3:GetObject"
      Resource  = [
        aws_s3_bucket.s3_bucket.arn,
        "${aws_s3_bucket.s3_bucket.arn}/*"
      ]
    }]
  })
}
```
> **Note:** No `provider` block in the module—providers are inherited from the root module.

### **`variables.tf`**
```hcl
variable "bucket_name" {
  description = "Globally unique S3 bucket name."
  type        = string
}

variable "tags" {
  description = "Tags to apply to the bucket."
  type        = map(string)
  default     = {}
}
```

### **`outputs.tf`**
```hcl
output "arn"    { description = "Bucket ARN";   value = aws_s3_bucket.s3_bucket.arn }
output "name"   { description = "Bucket name";  value = aws_s3_bucket.s3_bucket.id }
output "domain" { description = "Website DNS";  value = aws_s3_bucket_website_configuration.s3_bucket.website_domain }
```

---

## 4) Call the module from the root module

### **`main.tf` (root)**
```hcl
module "website_s3_bucket" {
  source      = "./modules/aws-s3-static-website-bucket"
  bucket_name = "<UNIQUE BUCKET NAME>"  # e.g., "laura-example-2025-11-04"
  tags = {
    Terraform   = "true"
    Environment = "dev"
  }
}
```
> Replace `<UNIQUE BUCKET NAME>` with a **globally unique** S3 name.

### **`outputs.tf` (root)**
```hcl
output "website_bucket_arn"    { value = module.website_s3_bucket.arn }
output "website_bucket_name"   { value = module.website_s3_bucket.name }
output "website_bucket_domain" { value = module.website_s3_bucket.domain }
```
(Your root can also expose outputs from other modules, e.g., VPC, EC2.)

---

## 5) Install, apply, and where modules live
- **Install**: `terraform get` (or `terraform init`) installs/updates modules.
  - Remote modules → downloaded to `.terraform/`
  - **Local modules → referenced directly**; changes are picked up without re‑running `init/get`.
- **Provision**: `terraform apply` then confirm `yes`.

---

## 6) Upload site content & browse
Upload the sample website to your bucket (after apply):
```bash
aws s3 cp modules/aws-s3-static-website-bucket/www/ s3://$(terraform output -raw website_bucket_name)/ --recursive
```
Visit:
```
https://<YOUR-BUCKET>.s3-website-<REGION>.amazonaws.com/index.html
```

---

## 7) Clean up
1) Remove uploaded objects:
```bash
aws s3 rm s3://$(terraform output -raw website_bucket_name)/ --recursive
```
2) Destroy infra:
```bash
terraform destroy
```

---

## 8) Design tips & best practices
- **Expose** only useful knobs as variables (e.g., `bucket_name`, `tags`); keep opinionated defaults.
- **Outputs** are the supported way to return info to callers.
- **Docs & license**: add `README.md` and `LICENSE` (good hygiene for sharing).
- **Security**: Review public-read policies; restrict as needed for your org’s standards.
- **Composable**: Write modules so they can be safely combined with others (networking, CDN, etc.).

---

## Quick Commands Recap
```bash
# from repo root
terraform init        # or: terraform get
terraform apply       # create module resources
terraform output      # see bucket name/domain
aws s3 cp modules/aws-s3-static-website-bucket/www/ s3://$(terraform output -raw website_bucket_name)/ --recursive
terraform destroy     # cleanup (after emptying bucket)
```
