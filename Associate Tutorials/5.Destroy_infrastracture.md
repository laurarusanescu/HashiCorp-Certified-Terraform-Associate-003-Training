# Summary Notes: Destroy Infrastructure with Terraform

## Goal
Safely remove infrastructure when it’s no longer needed. Terraform can:
- Destroy **specific resources** by removing them from configuration and applying.
- Destroy **everything managed** by the workspace via `terraform destroy`.

---

## Prerequisites
- Terraform CLI ≥ **1.2.0**
- AWS CLI
- AWS account with permissions in **us-west-2**
- Existing config & resources from prior tutorials (EC2, VPC, security groups).

---

## Option A — Remove a Single Resource
1) **Comment out** the resource and any dependent outputs.
   - `main.tf` (remove EC2 instance):
   ```hcl
   /*
   resource "aws_instance" "app_server" {
     ami           = data.aws_ami.ubuntu.id
     instance_type = var.instance_type
     vpc_security_group_ids = [module.vpc.default_security_group_id]
     subnet_id              = module.vpc.private_subnets[0]
     tags = { Name = var.instance_name }
   }
   */
   ```
   - `outputs.tf` (remove output referring to the instance):
   ```hcl
   /*
   output "instance_hostname" {
     description = "Private DNS name of the EC2 instance."
     value       = aws_instance.app_server.private_dns
   }
   */
   ```

2) **Apply** the change:
```bash
terraform apply
# Plan: 0 to add, 0 to change, 1 to destroy
# Confirm: yes
```
- Terraform destroys only the **EC2 instance** and removes the output.

---

## Option B — Destroy the Entire Workspace
Use when the whole environment is no longer required (e.g., ephemeral test envs).
```bash
terraform destroy
# Plan: 0 to add, 0 to change, N to destroy
# Confirm: yes
```
- Terraform destroys all managed resources in **dependency order** (e.g., route associations → subnets → IGW → VPC).

---

## How Terraform Handles Destruction
- Builds a **dependency graph** to determine safe order of operations.
- Runs destroys **in parallel** where possible, respecting dependencies.
- Prompts for confirmation before making irreversible changes.

---

## Outputs & State
- When removing resources, also remove any **outputs** that reference them to keep the configuration valid.
- Terraform stores results (including outputs) in **state** (`terraform.tfstate`).
- State can include **sensitive information**; keep it secure and consider using **remote state** (e.g., HCP Terraform) for team workflows.

---

## Good Practices
- **Review the plan** carefully before confirming destructive changes.
- Clean up **ephemeral environments** promptly to avoid costs.
- Keep modules and resources organized so dependencies are clear.
- Version-control the config and the **lock file** (`.terraform.lock.hcl`).

---

## Common Issues & Tips
- **Dependency errors:** Ensure you removed dependent outputs/resources or destroy in correct order.
- **Stuck destroys:** Some cloud resources have **deletion protection** or dependencies outside Terraform—resolve those first.
- **IAM/Permissions:** Verify permissions allow delete operations for all resources.
- **Orphans:** If resources were changed outside Terraform, run `terraform refresh` (or a new plan) to update state before destroy.

---

## Commands Reference
```bash
# Preview before removing a resource (after you comment it out)
terraform plan

# Apply removal of a resource
terraform apply

# Destroy the entire workspace
terraform destroy

# Inspect what Terraform currently manages
terraform state list
```

---

## Next Step
Use **HCP Terraform** to store state remotely and run operations in a consistent, secure environment.
