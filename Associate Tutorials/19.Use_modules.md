# Using Terraform Registry Modules in Configuration

## Overview
In this tutorial, you will learn how to use **Terraform modules** from the **Terraform Registry** to provision AWS infrastructure. The tutorial demonstrates using modules to create a **VPC** and **EC2 instances**, emphasizing reusable, version-controlled infrastructure components.

---

## 1. Why Use Registry Modules?
Modules from the **Terraform Registry** provide prebuilt, reusable infrastructure components that simplify Terraform configuration.

**Benefits:**
- Reduce code duplication.
- Standardize best practices.
- Accelerate development.
- Allow modular, maintainable infrastructure.

---

## 2. Prerequisites
- Terraform v1.1+ installed locally.
- AWS account with configured credentials.
- Optional: HCP Terraform for remote state management.

Clone the example repository:
```bash
git clone https://github.com/hashicorp-education/learn-terraform-modules-use
cd learn-terraform-modules-use
```

---

## 3. The Terraform Registry
The **Terraform Registry** provides publicly available modules for different providers (AWS, Azure, GCP, etc.). Each module page includes:
- Source and version.
- Input variables.
- Outputs.
- Example configurations.

### Example module block:
```hcl
module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "3.18.1"
}
```
- `source`: Specifies where to load the module from (e.g., Terraform Registry, GitHub, local).
- `version`: Pin the exact version to ensure reproducibility.

> ⚠️ Always specify the version to avoid unexpected updates when new releases are published.

---

## 4. Review Example Configuration

### **terraform.tf**
Defines required providers and Terraform version:
```hcl
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 4.49.0"
    }
  }
  required_version = ">= 1.1.0"
}
```

### **main.tf**
Includes provider configuration and two modules:
```hcl
provider "aws" {
  region = "us-west-2"
}

module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = "3.18.1"
  name = var.vpc_name
  cidr = var.vpc_cidr
  azs  = var.vpc_azs
  private_subnets = var.vpc_private_subnets
  public_subnets  = var.vpc_public_subnets
  enable_nat_gateway = var.vpc_enable_nat_gateway
  tags = var.vpc_tags
}

module "ec2_instances" {
  source  = "terraform-aws-modules/ec2-instance/aws"
  version = "4.3.0"
  count   = 2
  name    = "my-ec2-cluster-${count.index}"
  ami     = "ami-0c5204531f799e0c6"
  instance_type = "t3.micro"
  vpc_security_group_ids = [module.vpc.default_security_group_id]
  subnet_id = module.vpc.public_subnets[0]
  tags = {
    Terraform   = "true"
    Environment = "dev"
  }
}
```

This configuration provisions:
- A **VPC** (networking infrastructure).
- Two **EC2 instances** deployed in the VPC.

---

## 5. Input Variables
Modules support input variables, allowing customization without changing the module code.

### **variables.tf**
```hcl
variable "vpc_name" { default = "example-vpc" }
variable "vpc_cidr" { default = "10.0.0.0/16" }
variable "vpc_azs" { default = ["us-west-2a", "us-west-2b", "us-west-2c"] }
variable "vpc_private_subnets" { default = ["10.0.1.0/24", "10.0.2.0/24"] }
variable "vpc_public_subnets"  { default = ["10.0.101.0/24", "10.0.102.0/24"] }
variable "vpc_enable_nat_gateway" { default = true }
variable "vpc_tags" {
  default = {
    Terraform   = "true"
    Environment = "dev"
  }
}
```

You can override these defaults with command-line variables or `.tfvars` files.

---

## 6. Output Values
Modules can expose **outputs**, allowing you to use information from child modules in your root configuration.

### **outputs.tf**
```hcl
output "vpc_public_subnets" {
  description = "IDs of the VPC's public subnets"
  value       = module.vpc.public_subnets
}

output "ec2_instance_public_ips" {
  description = "Public IPs of EC2 instances"
  value       = module.ec2_instances[*].public_ip
}
```

Terraform uses the `module.<NAME>.<OUTPUT>` pattern to reference module outputs.

---

## 7. Provision Infrastructure

### Initialize
```bash
terraform init
```
Installs providers and modules into `.terraform/modules`.

### Apply
```bash
terraform apply
```
Terraform provisions your resources and displays outputs, e.g.:
```
Outputs:
ec2_instance_public_ips = [
  "54.245.140.252",
  "34.219.48.47"
]
vpc_public_subnets = [
  "subnet-0cb9ff659ba66a7dd",
  "subnet-0c2788b6ffb0611c0"
]
```

---

## 8. How Modules Work Internally
When you run `terraform init` or `terraform get`, Terraform downloads modules into `.terraform/modules`.  
Example directory structure:
```
.terraform/modules/
├── ec2_instances
├── modules.json
└── vpc
```

For local modules, Terraform creates a symbolic link instead of downloading.

---

## 9. Clean Up Resources
Destroy all infrastructure to avoid costs:
```bash
terraform destroy
```

Expected output:
```
Destroy complete! Resources: 22 destroyed.
```

---

## 10. Key Takeaways
- Use the **Terraform Registry** to find and reuse prebuilt modules.
- Always **pin module versions** for reproducibility.
- Use **variables** to parameterize modules and **outputs** to share values.
- Modules improve **consistency**, **speed**, and **maintainability**.

---

## 11. Next Steps
- Create a custom module to host a static website in an S3 bucket.
- Learn about **no-code modules** in HCP Terraform.
- Explore [Terraform Registry](https://registry.terraform.io/) to discover reusable modules.
