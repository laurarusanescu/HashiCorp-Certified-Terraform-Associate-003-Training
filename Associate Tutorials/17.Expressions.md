# Terraform Dynamic Expressions Tutorial

## Overview
This tutorial explores **Terraform expressions** — constructs that allow dynamic computation of values within configuration files. Expressions can be used to define conditional logic, handle multiple resources, and output computed values.

You will learn how to:
- Use **conditional expressions** for dynamic naming and tagging.
- Use **count** with conditionals to control resource creation.
- Apply **splat expressions** to output multiple resource attributes.

---

## Prerequisites
- Terraform v1.1+ installed locally.
- AWS account with credentials configured.
- Familiarity with Terraform basics and the workflow (`init`, `plan`, `apply`, `destroy`).

Clone the example repository:
```bash
git clone https://github.com/hashicorp-education/learn-terraform-expressions
cd learn-terraform-expressions
```

---

## 1. Conditional Expressions

Conditional expressions in Terraform select a value based on whether a condition evaluates to `true` or `false`.

### Example:
```hcl
locals {
  name  = (var.name != "" ? var.name : random_id.id.hex)
  owner = var.team
  common_tags = {
    Owner = local.owner
    Name  = local.name
  }
}
```
This assigns:
- `local.name` → `var.name` if it’s not empty.  
- Otherwise, it uses `random_id.id.hex`.

### Syntax:
```
condition ? true_value : false_value
```

Example for dynamic naming:
| Condition | True Result | False Result |
|------------|-------------|--------------|
| `var.name != ""` | Use `var.name` | Use `random_id.id.hex` |

---

## 2. Using Locals for Tags

You can use local values (`local.common_tags`) to standardize resource tagging.

### Example:
```hcl
resource "aws_vpc" "my_vpc" {
  cidr_block = var.cidr_vpc
  tags       = local.common_tags
}

resource "aws_elb" "learn" {
  instances = aws_instance.ubuntu.id
  tags      = local.common_tags
}
```
> ⚠️ **Tip:** Using locals improves readability but can add lifecycle complexity.

---

## 3. Conditional Count Criteria

The `count` parameter supports conditional logic, enabling dynamic resource creation.

### Define a boolean variable:
```hcl
variable "high_availability" {
  type        = bool
  description = "Deploy 3 instances if true, else 1 instance"
  default     = true
}
```

### Use conditionals in resource definition:
```hcl
resource "aws_instance" "ubuntu" {
  count                       = (var.high_availability ? 3 : 1)
  ami                         = data.aws_ami.ubuntu.id
  instance_type               = "t2.micro"
  associate_public_ip_address = (count.index == 0 ? true : false)
  subnet_id                   = aws_subnet.subnet_public.id
  tags                        = merge(local.common_tags)
}
```
| Condition | Result |
|------------|---------|
| `var.high_availability == true` | Create 3 instances |
| `var.high_availability == false` | Create 1 instance |
| `count.index == 0` | Assign public IP |

---

## 4. Splat Expressions (`[*]`)

Splat expressions allow you to retrieve values from **multiple instances** of a resource.

### Example:
```hcl
output "private_addresses" {
  description = "Private DNS for AWS instances"
  value       = aws_instance.ubuntu[*].private_dns
}
```
This returns a **list** of private DNS names for all EC2 instances.

### To reference a single instance:
```hcl
aws_instance.ubuntu[0].private_dns
```

### Example ELB with splat:
```hcl
resource "aws_elb" "learn" {
  instances = aws_instance.ubuntu[*].id
  tags      = local.common_tags
}
```

---

## 5. Terraform Workflow Recap
1. **Initialize:** `terraform init`
2. **Plan:** `terraform plan`
3. **Apply:** `terraform apply`
4. **Verify Outputs:** View `private_addresses` and `first_tags`
5. **Destroy:** `terraform destroy`

### Example Output:
```hcl
first_tags = tomap({
  "Name" = "terraform"
  "Owner" = "hashicorp"
})

private_addresses = [
  "ip-172-16-10-133.us-east-2.compute.internal",
  "ip-172-16-10-244.us-east-2.compute.internal",
  "ip-172-16-10-63.us-east-2.compute.internal",
]
```

---

## 6. Key Takeaways
- **Conditionals (`? :`)** enable dynamic configuration choices.
- **Count with conditionals** controls how many resources Terraform creates.
- **Splat expressions (`[*]`)** return lists of values across multiple resources.
- **Locals** and **tags** improve consistency and manageability.

---

## 7. Next Steps
To deepen your Terraform skills:
- Learn to use **local values** to simplify configurations.
- Review Terraform **functions** for computation and data transformation.
- Explore **input variables** for configuration customization.
- Practice combining **conditionals, splats, and locals** for advanced automation.
