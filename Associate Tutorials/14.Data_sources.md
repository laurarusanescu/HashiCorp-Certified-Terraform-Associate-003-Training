# Terraform Data Sources & Remote State — Quick Cheat Sheet

Use this as a fast reference when wiring dynamic inputs, cross‑workspace data sharing, and region portability.

---

## 1) Why data sources?
**Data sources** fetch read‑only info from providers or other Terraform states at plan/apply time. They keep configs portable and DRY (e.g., get AZs for any region, latest AMI IDs, or outputs from another workspace).

---

## 2) Core syntax
```hcl
# General
data "<PROVIDER>_<TYPE>" "<NAME>" {
  # arguments/filters
}

# Referencing
${data.<PROVIDER>_<TYPE>.<NAME>.<attribute>}
```
---

## 3) AWS examples you’ll reach for often

### a) Region & AZ portability
```hcl
provider "aws" {
  region = var.aws_region
}

data "aws_region" "current" {}

data "aws_availability_zones" "available" {
  state = "available"
  filter {
    name   = "zone-type"
    values = ["availability-zone"]
  }
}

locals {
  az_names = data.aws_availability_zones.available.names
}
```

### b) Latest Amazon Linux 2 AMI (x86_64)
```hcl
data "aws_ami" "amazon_linux" {
  most_recent = true
  owners      = ["amazon"]
  filter {
    name   = "name"
    values = ["amzn2-ami-hvm-*-x86_64-gp2"]
  }
}

resource "aws_instance" "app" {
  ami           = data.aws_ami.amazon_linux.id
  instance_type = var.instance_type
  # ...
}
```

### c) Slice CIDR lists with `slice()`
```hcl
module "vpc" {
  source  = "terraform-aws-modules/vpc/aws"
  version = ">= 3.14.0"

  cidr             = var.vpc_cidr_block
  azs              = data.aws_availability_zones.available.names
  public_subnets   = slice(var.public_subnet_cidr_blocks, 0, var.public_subnet_count)
  private_subnets  = slice(var.private_subnet_cidr_blocks, 0, var.private_subnet_count)
}
```

---

## 4) Cross‑workspace data with `terraform_remote_state` (HCP Terraform)

**Use case**: Network stack (VPC) in one workspace, App stack in another.

```hcl
# In the APP workspace
data "terraform_remote_state" "vpc" {
  backend = "remote"
  config = {
    organization = "YOUR_ORG"
    workspaces = { name = "learn-terraform-data-sources-vpc" }
  }
}
```

### Required in the source (VPC) workspace
- Expose only **root‑level outputs** you need, e.g.:
```hcl
output "aws_region"            { value = data.aws_region.current.name }
output "public_subnet_ids"     { value = module.vpc.public_subnets }
output "private_subnet_ids"    { value = module.vpc.private_subnets }
output "lb_security_group_ids" { value = module.vpc.lb_security_group_id }
output "app_security_group_ids"{ value = module.vpc.default_security_group_id }
```
> Note: Names vary by the VPC module; export what your module actually exposes.

### Wire the APP workspace to those outputs
```hcl
provider "aws" {
  region = data.terraform_remote_state.vpc.outputs.aws_region
}

module "elb_http" {
  # ...
  security_groups = data.terraform_remote_state.vpc.outputs.lb_security_group_ids
  subnets         = data.terraform_remote_state.vpc.outputs.public_subnet_ids
}
```

### EC2s per subnet using remote outputs
```hcl
variable "instances_per_subnet" { type = number, default = 2 }

resource "aws_instance" "app" {
  count = var.instances_per_subnet * length(data.terraform_remote_state.vpc.outputs.private_subnet_ids)

  ami                    = data.aws_ami.amazon_linux.id
  subnet_id              = data.terraform_remote_state.vpc.outputs.private_subnet_ids[count.index % length(data.terraform_remote_state.vpc.outputs.private_subnet_ids)]
  vpc_security_group_ids = data.terraform_remote_state.vpc.outputs.app_security_group_ids
}
```

#### HCP Terraform permission step
- In **VPC workspace → Settings → General → Remote state sharing**: choose **Share with specific workspaces** and add the App workspace.

---

## 5) Outputs: what to expose
Keep outputs small and specific. Only export what downstream stacks need:
- Region (`aws_region`)
- Subnet IDs (public/private)
- SG IDs (for LB / app)
- VPC ID as needed

```hcl
output "vpc_id"  { value = module.vpc.vpc_id }
output "aws_region" { value = data.aws_region.current.name }
```

---

## 6) Gotchas & tips
- **Only root outputs** are visible to `terraform_remote_state`. You can’t read deep module attributes unless you re‑expose them as root outputs.
- **Region drift**: don’t hard‑code AMI IDs or AZ names. Use `aws_region`, `aws_availability_zones`, and `aws_ami` data sources.
- **Order matters**: destroy **App** before **VPC** to avoid dependency errors from the cloud API.
- **Security**: remote state sharing is explicit. Limit who can read state; outputs may include identifiers. For secrets, prefer Vault or HCP Terraform variables and avoid exposing secrets as outputs.
- **Performance**: Filters on data sources should be as specific as possible to reduce provider API calls.
- **Reproducibility**: Pin provider versions (`required_providers`) and module versions. Commit `.terraform.lock.hcl`.
- **Error: missing permission to read remote state** → Check HCP Terraform **Remote state sharing** and organization/workspace names.

---

## 7) Minimal file layout (pattern)
```
network/  (VPC workspace)
  main.tf
  variables.tf
  outputs.tf

app/      (App workspace)
  main.tf
  variables.tf
  outputs.tf
```
- Network exports region, subnet & SG IDs.
- App imports them via `terraform_remote_state` and deploys ALB & EC2s.

---

## 8) Handy commands
```bash
# Initialize / re-init after provider/module/backend changes
terraform init

# Preview with vars
terraform plan -var aws_region=us-west-1

# Apply with confirmation
terraform apply

# Destroy (app first, then vpc)
terraform destroy

# Output values (human)
terraform output

# Output one value raw (machine-friendly)
terraform output -raw lb_url
```

---

## 9) Example variables you’ll likely need
```hcl
variable "aws_region" { type = string, default = "us-west-2" }
variable "vpc_cidr_block" { type = string, default = "10.0.0.0/16" }
variable "public_subnet_cidr_blocks"  { type = list(string) }
variable "private_subnet_cidr_blocks" { type = list(string) }
variable "public_subnet_count"  { type = number, default = 2 }
variable "private_subnet_count" { type = number, default = 2 }
variable "instances_per_subnet" { type = number, default = 2 }
variable "instance_type"        { type = string, default = "t3.micro" }
```
---

### TL;DR
- Replace hard-coded region/AZs/AMI with data sources.
- Split stacks (VPC vs App); share only required root outputs.
- Use `terraform_remote_state` + HCP state sharing for cross‑workspace wiring.
- Pin versions, protect state, and keep outputs minimal.
