# Summary Notes: Terraform — Protect Sensitive Input Variables

## Why this matters
- Infra configs often need **secrets/PII** (DB creds, API tokens).  
- Risks: exposure via **CLI output**, **logs**, **VCS**, and **state files**.  
- Terraform features help **redact** in outputs and **control** how values are set, but **you** must also secure state and secret sources.

---

## Core mechanics
### 1) Mark inputs as sensitive
```hcl
variable "db_username" {
  description = "DB admin username"
  type        = string
  sensitive   = true
}
variable "db_password" {
  description = "DB admin password"
  type        = string
  sensitive   = true
}
resource "aws_db_instance" "database" {
  # ...
  username = var.db_username
  password = var.db_password   # AWS provider treats this as sensitive anyway
}
```
Effects:
- Terraform **redacts** values in `plan/apply/destroy` output and logs.
- Prevents accidental exposure when referenced elsewhere (e.g., outputs).

> ⚠️ The **provider** may independently mark some arguments sensitive (e.g., `password`), but always mark your variables sensitive too.

### 2) Securely pass values (no defaults for secrets)
**Options (lowest → highest precedence):**
- `terraform.tfvars` or `*.auto.tfvars`  
- `-var-file="secret.tfvars"`  
- Environment variables: `TF_VAR_<name>`  
- CLI flags: `-var 'name=value'` (avoid for secrets if shell history is logged)

Examples:
```hcl
# secret.tfvars (DO NOT commit)
db_username = "admin"
db_password = "insecurepassword"
```
```bash
terraform apply -var-file="secret.tfvars"

# or environment variables (CE)
export TF_VAR_db_username=admin
export TF_VAR_db_password='adifferentpassword'
terraform apply
```

### 3) Outputs with secrets
- Terraform **errors** if an output derives from sensitive values unless you mark it `sensitive = true`.
```hcl
output "db_connect_string" {
  description = "MySQL connection string"
  value       = "Server=${aws_db_instance.database.address}; Database=ExampleDB; Uid=${var.db_username}; Pwd=${var.db_password}"
  sensitive   = true  # required to allow output, will be redacted in CLI
}
```

### 4) State file reality
- **Local state** (`terraform.tfstate`) is **plain text**; includes secret values even if marked sensitive.
- Example grep shows passwords present.
- Therefore you **must**:  
  - Store state **remotely** and **encrypted at rest** (e.g., **HCP Terraform** / Terraform Enterprise backends).  
  - Lock down access (IAM, ACLs), enable versioning/rotation.  
  - Avoid committing state to VCS.  
  - Consider sub‑state separation for least privilege.

---

## Recommended practices (checklist)
- [ ] **Never** hard‑code secrets in `.tf` files.  
- [ ] Put secret values in **`*.auto.tfvars` / `-var-file`** kept **out of VCS** (gitignore `*.tfvars`).  
- [ ] Prefer **environment variables** or **HCP Terraform sensitive variables** over CLI `-var`.  
- [ ] **Mark inputs `sensitive = true`** and mark any **outputs** that include them as `sensitive = true`.  
- [ ] Use **least-privilege** credentials; rotate regularly.  
- [ ] Use **remote backends** with encryption + state locking (HCP Terraform), not local state.  
- [ ] For dynamic secrets, integrate **HashiCorp Vault** (or cloud secret managers) via providers/data sources.  
- [ ] Review logs/CI traces to ensure secrets aren’t echoed; scrub where needed.  
- [ ] Avoid writing secrets to files during provisioners/user_data unless necessary; if used, **remove** and **rotate**.  

---

## Quick workflow from the tutorial
```bash
git clone https://github.com/hashicorp-education/learn-terraform-sensitive-variables
cd learn-terraform-sensitive-variables

terraform init
terraform apply                       # creates VPC, ALB, EC2, DB (hard-coded creds initially)

# Refactor: create sensitive variables & wire into DB resource
# variables.tf: db_username/db_password with sensitive=true
# main.tf: reference var.db_username/var.db_password

# Option A: tfvars
echo 'db_username="admin"
db_password="mypassword"' > secret.tfvars
terraform apply -var-file="secret.tfvars"

# Option B: env vars
export TF_VAR_db_username=admin TF_VAR_db_password='anothersecret'
terraform apply

# Outputs: mark sensitive
# outputs.tf -> output "db_connect_string" { sensitive = true }

# Clean up
terraform destroy
```

---

## HCP Terraform & Vault
- **HCP Terraform**: securely stores sensitive variables (encrypted), handles remote execution & state encryption/locking.  
- **Vault**: central secret management; inject short‑lived creds via `vault_*` providers/data sources into Terraform.

---

## Gotchas & tips
- Sensitive **does not** obfuscate in **state**; protect state first.  
- Shell histories/CI logs can leak secrets set via CLI flags or `export`; prefer HCP variables or masked CI secrets.  
- Redaction applies to **UI output**; if you **concatenate** secrets into strings and write to files/user_data, they’ll appear verbatim.  
- Test with `terraform plan` to confirm redaction; review pipelines for accidental `set -x` or `-v` flags.

