# Terraform: Use Refresh-Only Mode to Sync State — Summary Notes

## Overview
Terraform's **state file** must accurately represent your real infrastructure. The `-refresh-only` flag lets you safely update the **state file** to match actual resources — without modifying them. This provides visibility into external changes and prevents accidental overwrites.

---

## 1. What is a Refresh?
**Refresh** = Comparing Terraform’s state with the actual infrastructure.  
Terraform uses this to detect drift and plan changes accurately.

### How it Works
- Every `terraform plan` and `terraform apply` automatically runs an **in-memory refresh**.
- You can run a **refresh-only plan** to preview how Terraform would update the state file without changing infrastructure.

> ✅ Use `terraform plan -refresh-only` to safely detect and review drift.  
> ⚠️ Avoid `terraform refresh` (deprecated) — it overwrites state immediately.

---

## 2. Setup Example
Clone the example repo:
```bash
git clone https://github.com/hashicorp-education/learn-terraform-refresh
cd learn-terraform-refresh
terraform init
terraform apply
```
This configuration provisions an **EC2 instance** with the latest Amazon Linux AMI in region `us-east-2`.

---

## 3. Simulate Drift
Modify the AWS provider region (mimics credential or config change):

Create `terraform.tfvars`:
```hcl
region = "us-west-2"
```
Now the provider points to `us-west-2`, but your EC2 instance exists in `us-east-2`.

Run:
```bash
terraform plan -refresh-only
```

### Output Example
```
Note: Objects have changed outside of Terraform

- resource "aws_instance" "server" {
    # Terraform thinks the instance was deleted
}
```
Terraform can’t find your instance in the new region, so it plans to remove it from state.

---

## 4. Do Not Apply in This Case
Running:
```bash
terraform apply -refresh-only
```
would **remove** the instance from your state (since Terraform believes it was destroyed), while it actually still exists in `us-east-2`.

> Always verify drift causes before applying a refresh-only plan.  
> A refresh-only apply changes **only the state file**, never real resources.

---

## 5. Refresh Behavior Comparison

| Command | Description | Safe? | Deprecated? |
|----------|-------------|-------|--------------|
| `terraform refresh` | Immediately updates local state to match reality (no preview) | ❌ | ✅ Deprecated |
| `terraform plan -refresh-only` | Previews state updates, doesn’t change infra | ✅ | ❌ |
| `terraform apply -refresh-only` | Updates state (and outputs) without touching infra | ✅ | ❌ |

---

## 6. Why `-refresh-only` is Safer
- You **see** proposed state changes before they are applied.
- Works with **remote backends** (e.g., HCP Terraform, S3).
- Prevents silent drift overwrites.
- Updates **outputs** for any downstream workspaces using `terraform_remote_state`.

> The `refresh` subcommand cannot be reviewed collaboratively and is **not supported** in remote workspaces.

---

## 7. Implicit vs. Explicit Refresh

| Mode | When It Happens | Effect |
|------|------------------|--------|
| **Implicit Refresh** | On every `plan`, `apply`, `destroy` | In-memory reconciliation before planning |
| **Explicit Refresh (refresh-only)** | Manual via flag | Updates recorded state only |

---

## 8. Cleanup
To reset region and destroy infrastructure:
```bash
rm terraform.tfvars
terraform destroy
```
Confirm with **yes** to remove the instance.

---

## 9. Best Practices
✅ Always use `-refresh-only` before major operations to verify drift.  
✅ Review output before applying.  
✅ Use **remote state backends** for collaboration and locking.  
❌ Do not rely on `terraform refresh` (deprecated).  
❌ Avoid running refresh-only blindly — inspect proposed changes first.

---

## 10. Key Takeaways
- `-refresh-only` lets you safely **sync state** with real infrastructure.  
- Use it for **drift detection** and **state correction** without touching infra.  
- Prefer `plan -refresh-only` + review before applying.  
- Deprecated `terraform refresh` should be replaced with this workflow.

---

**Next Steps**
- Learn **drift detection in HCP Terraform**
- Practice **state manipulation** commands (`import`, `state mv`, etc.)
- Review docs:  
  - [Terraform Refresh Command](https://developer.hashicorp.com/terraform/cli/commands/refresh)  
  - [Refresh-Only Mode](https://developer.hashicorp.com/terraform/cli/run/refresh-only)  
