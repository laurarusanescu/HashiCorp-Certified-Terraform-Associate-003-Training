# Summary Notes: Terraform Execution Plans & `terraform plan`

## Core Workflow (after writing config)
1) **init** – prepare workspace (backend, providers, modules, lock file)  
2) **plan** – preview diff between config and real state  
3) **apply** – enact the planned creates/updates/destroys

---

## What `terraform plan` Does
- Compares **written configuration** ↔ **current state** (and refreshed provider data).
- Produces an **execution plan** showing actions (`+ create`, `~ update`, `-/+ replace`, `- destroy`).
- Can **save** a plan (`-out file`) for later **apply** (important for CI/CD reproducibility).
- Guarantees that **applied changes** match the **approved plan** (even across machines/times).
- `terraform destroy` creates a **destroy plan** (shortcut for plan+apply destroy).

**Prereqs:** Terraform v1.6+, AWS account/creds, `jq` CLI, example repo:
```bash
git clone https://github.com/hashicorp-education/learn-terraform-plan
cd learn-terraform-plan
```

---

## Initialize & Create First Plan
```bash
terraform init
terraform plan -out tfplan         # saves a binary plan file
terraform show "tfplan"            # human-readable
terraform show -json tfplan | jq > tfplan.json
```
First run (empty state) → **all resources planned to create**.

---

## What’s Inside a Plan (JSON highlights)
- **`terraform_version` / `format_version`**: versions that must match during apply.  
- **`.configuration`**: snapshot of modules/providers and their **version constraints** (from lock file), inputs/expressions, references.  
  - `provider_config`: provider name, full source, version constraints.  
  - `root_module.resources`: resource blocks and expressions.  
  - `root_module.module_calls`: child module sources, inputs, outputs.  
- **`resource_changes[]`** (per-address diff):
  - `actions`: `["create"]`, `["update"]`, or `["delete","create"]` (replace)
  - `before` / `after`: previous vs. desired state (null on first create)
  - `after_unknown`: attrs computed at apply time
  - `before_sensitive` / `after_sensitive`: sensitive attributes map
- **`planned_values`**: consolidated “after” view for all addresses (what will exist).  
  - Used by **Sentinel policies** and **cost estimation**.
- **`variables`**: captured input variables used for the plan (values included → handle with care).  
- **`prior_state`**: exact snapshot of state before the plan (present on subsequent runs).

> ⚠️ **Security**: Plan files (binary or JSON) can contain **sensitive data**. Never commit to VCS; store securely. Prefer environment variables for secrets over tfvars where possible.

---

## Apply a Saved Plan
```bash
terraform apply "tfplan"   # no prompt; runs exactly what was planned
```

---

## Evolving the Config: Variables & Replans
1) Add sensitive input variable in `variables.tf` and value in `terraform.tfvars`:
```hcl
variable "secret_key" { type=string, sensitive=true }
```
```hcl
# terraform.tfvars
secret_key = "TOPSECRET"
```
2) Reference in module input, re-plan & save:
```bash
terraform plan -out tfplan-input-var
terraform show -json tfplan-input-var | jq > tfplan-input-var.json
```
- Plan now includes `variables.secret_key` in plaintext (handle securely).
- `resource_changes` may show **replace** if a changed arg **cannot be updated in place**:
  - `actions: ["delete","create"]`
  - `action_reason: "replace_because_cannot_update"`

---

## Targeted & Specialized Plans (useful flags)
- **Destroy plan** for everything:
  ```bash
  terraform plan -destroy -out tfplan-destroy
  terraform apply tfplan-destroy
  ```
- **Targeting** specific resources (use carefully in automation):
  ```bash
  terraform plan -target=module.ec2-instance.aws_instance.main
  ```
- **Refresh-only** plan (update state without changing infra):
  ```bash
  terraform plan -refresh-only
  ```
- **Force replace** a resource:
  ```bash
  terraform plan -replace=module.hello.random_pet.server
  ```

---

## Best Practices
- **Always review** the plan (or JSON diff) before apply—especially in CI/CD.
- **Save plans** for promotion gates and reproducibility.
- Treat plan artifacts as **secrets**; rotate and restrict access.
- Use **version pinning** and commit `.terraform.lock.hcl` for reproducibility.
- Prefer **input variables** and **modules** for reusability and governance.

---

## Quick Command Reference
```bash
terraform init
terraform plan [-out FILE] [flags]
terraform show ["tfplan" | -json "tfplan"]
terraform apply ["tfplan"]
terraform plan -destroy -out tfplan-destroy
terraform plan -refresh-only
terraform plan -target=ADDR
terraform plan -replace=ADDR
```

---

## Cleanup
```bash
terraform plan -destroy -out tfplan-destroy
terraform apply tfplan-destroy
```
